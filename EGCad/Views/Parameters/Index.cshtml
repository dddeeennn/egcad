@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="page-header">
    <h2>Введите параметры</h2>
</div>
<div class="form-group">
    <form class="form-inline" role="form">
        <div class="form-group">
            <input type="text" class="form-control" id="parameterName" placeholder="Название параметра">
        </div>
        <div class="form-group">
            <input type="text" class="form-control" id="parameterUnit" placeholder="Единицы измерения">
        </div>
        <span id="saveParameter" class="btn btn-default">Добавить</span>
    </form>
</div>
<div class="form-group">
    <table class="table table-bordered table-condensed" style="max-width: 1000px">
        <thead>
            <th class="col-sm-2">Номер</th>
            <th class="col-sm-4">Название параметра</th>
            <th class="col-sm-4">Единицы измерения</th>
            <th class="col-sm-2 glyphicon glyphicon-trash" style="text-align: center"></th>
        </thead>
        <tbody></tbody>
    </table>
</div>
<div class="form-group">
    <a href="@Url.Action("Index","TableParameters")" class="btn btn-primary">Далее</a>
</div>

<script type="text/html" id="parameterTmpl">
    <tr>
        <td data-content="Id"></td>
        <td data-content="Name"></td>
        <td data-content="Unit"></td>
        <td style="text-align: center"><a data-id="Id" class="remove-action btn-link glyphicon glyphicon-remove error"></a></td>
    </tr>
</script>

<script type="text/javascript">
    $(document).ready(function () {
        var container = $('#main');
        var sender = new egcad.Data.Sender();

        container.find("#saveParameter").on("click", saveHandler);

        sender.get("loadState", '@Url.Action("GetState")', {}, function (response) {
            if (response && response.statusCode == 0) {
                refreshState(response.data);
            }
        });

        function removeHandler(self) {
            var id = self.attr('id');
            sender.get("removeEntry", '@Url.Action("Remove")', { id: id }, function (response) {
                if (response && response.statusCode == 0) {
                    self.closest('tr').empty();
                    refreshState(response.data);
                } else {
                    alert('Ошибка при удалении параметра!');
                }
            });
        }

        function refreshState(state) {
            $('table tbody').loadTemplate($('#parameterTmpl'), state.items)
                                    .delegate(".remove-action", "click", function () {
                                        removeHandler($(this));
                                    });
        }

        function saveHandler() {
            var parameterName = container.find('#parameterName');
            var parameterUnit = container.find('#parameterUnit');

            if ((!parameterName.val()) || (!parameterUnit.val())) return;

            sender.get("saveParam", "parameters/save", { name: parameterName.val(), unit: parameterUnit.val() }, function (response) {
                if (response && response.statusCode == 0) {
                    parameterName.val('');
                    parameterUnit.val('');
                    refreshState(response.data);
                } else {
                    alert('Ошибка при сохранении параметра!');
                }
            }, null, {});
        };
    });


</script>
